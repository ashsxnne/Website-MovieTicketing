<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buy Ticket - Movie Ticket Booking</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header Styles */
    header {
      background-color: #e23020;
      padding: 15px 0;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    .logo {
      color: white;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 1px;
      user-select: none;
    }

    nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 25px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 25px;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    nav ul li a:hover,
    nav ul li a.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 40px;
      flex: 1;
      display: flex;
      gap: 40px;
    }

    /* Content Wrapper */
    .content-wrapper {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 40px;
      width: 100%;
    }

    /* Booking Form Section */
    .booking-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .section-title {
      color: #e23020;
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 10px;
      text-align: center;
    }

    .section-subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 40px;
      font-weight: 400;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      background: white;
      transition: all 0.3s ease;
      font-family: 'Roboto', sans-serif;
    }

    .form-select:focus {
      outline: none;
      border-color: #e23020;
      box-shadow: 0 0 0 3px rgba(226, 48, 32, 0.1);
    }

    .form-select:disabled {
      background: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }

    .note {
      color: #666;
      font-size: 0.85rem;
      font-weight: 400;
    }

    /* Seats Container */
    .seats-container {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-top: 15px;
      border: 2px dashed #dee2e6;
    }

    .seats-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .seat {
      width: 40px;
      height: 40px;
      background: #28a745;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .seat:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .seat.selected {
      background: #e23020;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(226, 48, 32, 0.4);
    }

    .seat.unavailable {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .seat.unavailable:hover {
      transform: none;
      box-shadow: none;
    }

    .screen-info {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 10px;
      font-weight: 600;
      margin-top: 20px;
    }

    /* Booking Fee */
    .booking-fee {
      background: linear-gradient(135deg, #e23020, #ff6b6b);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin: 30px 0;
      font-weight: 600;
      font-size: 1.2rem;
    }

    /* Book Button */
    .book-btn {
      width: 100%;
      background: linear-gradient(135deg, #e23020, #ff6b6b);
      color: white;
      border: none;
      padding: 16px 40px;
      font-size: 1.2rem;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(226, 48, 32, 0.3);
    }

    .book-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(226, 48, 32, 0.4);
    }

    .book-btn:active {
      transform: translateY(0);
    }

    /* Movie Preview Section */
    .movie-preview {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .movie-poster-container {
      text-align: center;
      margin-bottom: 25px;
    }

    .movie-poster {
      width: 100%;
      max-width: 300px;
      height: 400px;
      object-fit: cover;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
    }

    .movie-poster:hover {
      transform: scale(1.02);
    }

    .no-poster {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .movie-details {
      text-align: center;
    }

    .movie-title {
      color: #e23020;
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 15px;
      line-height: 1.3;
    }

    .movie-description {
      color: #666;
      line-height: 1.6;
      font-size: 0.95rem;
      text-align: left;
    }

    .movie-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
      text-align: left;
    }

    .meta-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      border-left: 4px solid #e23020;
    }

    .meta-label {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .meta-value {
      color: #666;
      font-size: 0.9rem;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 20px 0;
      background-color: #e23020;
      color: white;
      font-weight: 600;
      width: 100%;
      margin-top: auto;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* Loading States */
    .loading-seats {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #dee2e6;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .content-wrapper {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .movie-preview {
        position: static;
        order: -1;
      }

      .main-container {
        padding: 0 15px 30px;
      }
    }

    @media (max-width: 768px) {
      .nav-container {
        flex-direction: column;
        gap: 15px;
      }

      nav ul {
        gap: 15px;
      }

      .booking-section,
      .movie-preview {
        padding: 25px;
      }

      .seats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav-container">
      <div class="logo">
        Movie<span style="font-weight:400;">Ticket Booking</span>
      </div>
      <nav>
        <ul>
          <li><a href="{{ url_for('customer_dashboard') }}">Home</a></li>
          <li><a href="{{ url_for('movies') }}">Movies</a></li>
          <li><a href="{{ url_for('viewtickets') }}">Tickets Booked</a></li>
          <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="main-container">
    <div class="content-wrapper">
      <!-- Booking Form Section -->
      <section class="booking-section">
        <h1 class="section-title">Buy Tickets</h1>
        <p class="section-subtitle">Book your movie experience in just a few clicks</p>

        <form id="bookingForm" method="POST" action="{{ url_for('book_ticket') }}">
          <div class="form-group">
            <label for="movieSelect" class="form-label">Select Movie</label>
            <select id="movieSelect" name="movie" class="form-select" required>
              <option value="" disabled selected>-- Choose a movie --</option>
              <!-- Movies will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label for="dateSelect" class="form-label">Select Date</label>
            <select id="dateSelect" name="show_date" class="form-select" required disabled>
              <option value="" disabled selected>-- Select a date --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="timeSelect" class="form-label">Select Showtime</label>
            <select id="timeSelect" name="showtime" class="form-select" required disabled>
              <option value="" disabled selected>-- Select a time --</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Select Seats <span class="note">(Click to select, max 5 seats)</span></label>
            <div class="seats-container">
              <div class="seats-grid" id="seatsContainer">
                <div class="loading-seats">Please select a showtime to view available seats</div>
              </div>
            </div>
          </div>

          <!-- Hidden inputs to store selected data -->
          <input type="hidden" id="selectedSeats" name="seats" value="">
          <input type="hidden" id="bookingFee" name="fee" value="0">

          <div class="booking-fee" id="bookingFeeDisplay">Booking Fee: â‚±0</div>

          <button type="submit" class="book-btn">Book Now</button>
        </form>
      </section>

      <!-- Movie Preview Section -->
      <section class="movie-preview" id="moviePreview">
        <div class="movie-poster-container">
          <div id="posterContainer">
            <!-- Poster will be dynamically added here -->
          </div>
        </div>

        <div class="movie-details">
          <h2 class="movie-title" id="previewTitle">Select a Movie</h2>

          <div class="movie-meta" id="movieMeta" style="display: none;">
            <div class="meta-item">
              <div class="meta-label">Genre</div>
              <div class="meta-value" id="metaGenre">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Duration</div>
              <div class="meta-value" id="metaDuration">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Rating</div>
              <div class="meta-value" id="metaRating">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Status</div>
              <div class="meta-value" id="metaStatus">-</div>
            </div>
          </div>

          <div class="movie-description" id="previewDescription">
            Please select a movie from the dropdown to view details.
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>
    <p>DKC Collection 2025 | Movie Ticket Booking Â©</p>
  </footer>

  <!-- JavaScript remains the same as before -->
  <script>
    // Your existing JavaScript code goes here (same as previous version)
    const BOOKING_FEE_PER_TICKET = 125;
    const movieSelect = document.getElementById("movieSelect");
    const dateSelect = document.getElementById("dateSelect");
    const timeSelect = document.getElementById("timeSelect");
    const seatsContainer = document.getElementById("seatsContainer");
    const selectedSeatsInput = document.getElementById("selectedSeats");
    const bookingFeeInput = document.getElementById("bookingFee");
    const bookingFeeDisplay = document.getElementById("bookingFeeDisplay");
    const bookingForm = document.getElementById("bookingForm");
    let selectedSeats = [];
    let currentScheduleId = null;

    // Get selected movie from URL or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const selectedMovieFromURL = urlParams.get('movie');
    const storedMovie = localStorage.getItem("selectedMovie");
    const movieToSelect = selectedMovieFromURL || storedMovie;

    // Movie details with posters and descriptions - will be populated from database
    let movieDetails = {};

    // Function to fetch available seats from the server
    async function fetchAvailableSeats(scheduleId) {
        try {
            const response = await fetch(`/get_available_seats?schedule_id=${scheduleId}`);
            const data = await response.json();
            return data.available_seats || [];
        } catch (error) {
            console.error('Error fetching available seats:', error);
            return [];
        }
    }

    // Function to get schedules for a movie
    async function getSchedulesForMovie(movieTitle) {
        try {
            const response = await fetch(`/get_schedules_for_booking?movie_title=${encodeURIComponent(movieTitle)}`);
            const data = await response.json();
            return data.schedules || [];
        } catch (error) {
            console.error('Error fetching schedules:', error);
            return [];
        }
    }

    // Function to get ALL movies from database
    async function getAllMovies() {
        try {
            const response = await fetch('/get_movies');
            const movies = await response.json();

            // Build movie details object from database
            movies.forEach(movie => {
                movieDetails[movie.title] = {
                    poster: movie.poster_url || '',
                    description: movie.description || 'No description available.',
                    genre: movie.genre || '',
                    duration: movie.duration || '',
                    rating: movie.rating || ''
                };
            });

            return movies;
        } catch (error) {
            console.error('Error fetching movies:', error);
            return [];
        }
    }

    // Display available seats
    async function displaySeats() {
        seatsContainer.innerHTML = "<div class='loading-seats'>Loading available seats...</div>";
        selectedSeats = [];
        selectedSeatsInput.value = "";
        updateBookingFee();

        if (currentScheduleId) {
            try {
                const availableSeats = await fetchAvailableSeats(currentScheduleId);

                seatsContainer.innerHTML = "";

                const rows = ["A", "B", "C", "D", "E"];
                const seatsPerRow = 8;

                // Create seats grid
                const seatsGrid = document.createElement('div');
                seatsGrid.className = 'seats-grid';

                for (let r of rows) {
                    for (let i = 1; i <= seatsPerRow; i++) {
                        const seatLabel = r + i;
                        const seatEl = document.createElement("div");
                        seatEl.classList.add("seat");
                        seatEl.textContent = seatLabel;

                        if (!availableSeats.includes(seatLabel)) {
                            seatEl.classList.add("unavailable");
                        }

                        seatEl.addEventListener("click", () => {
                            if (seatEl.classList.contains("unavailable")) return;
                            if (selectedSeats.length >= 5 && !seatEl.classList.contains("selected")) {
                                alert("Maximum 5 seats allowed per booking.");
                                return;
                            }
                            seatEl.classList.toggle("selected");
                            if (seatEl.classList.contains("selected")) {
                                selectedSeats.push(seatLabel);
                            } else {
                                selectedSeats = selectedSeats.filter(seat => seat !== seatLabel);
                            }
                            selectedSeatsInput.value = selectedSeats.join(", ");
                            updateBookingFee();
                        });
                        seatsGrid.appendChild(seatEl);
                    }
                }

                seatsContainer.appendChild(seatsGrid);

                const screenInfo = document.createElement("div");
                screenInfo.className = 'screen-info';
                screenInfo.innerHTML = `ðŸŽ¬ Screen - ${availableSeats.length} seats available`;
                seatsContainer.appendChild(screenInfo);

            } catch (error) {
                console.error('Error displaying seats:', error);
                seatsContainer.innerHTML = "<div class='loading-seats'>Error loading seats. Please try again.</div>";
            }
        } else {
            seatsContainer.innerHTML = "<div class='loading-seats'>Please select a showtime to view available seats</div>";
        }
    }

    // Populate dates from schedules
    async function populateDates() {
        dateSelect.innerHTML = '<option value="" disabled selected>-- Select a date --</option>';
        timeSelect.innerHTML = '<option value="" disabled selected>-- Select a time --</option>';
        currentScheduleId = null;

        if (movieSelect.value) {
            const schedules = await getSchedulesForMovie(movieSelect.value);

            if (schedules.length > 0) {
                // Get unique dates
                const uniqueDates = [...new Set(schedules.map(schedule => schedule.show_date))];

                uniqueDates.forEach(date => {
                    const option = document.createElement("option");
                    option.value = date;
                    option.textContent = new Date(date).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    dateSelect.appendChild(option);
                });

                dateSelect.disabled = false;

                // Auto-select the first date if available
                if (uniqueDates.length > 0) {
                    dateSelect.value = uniqueDates[0];
                    await populateTimes();
                }
            } else {
                dateSelect.disabled = true;
                timeSelect.disabled = true;
                seatsContainer.innerHTML = "<div class='loading-seats'>No schedules available for this movie</div>";
            }
        } else {
            dateSelect.disabled = true;
            timeSelect.disabled = true;
            seatsContainer.innerHTML = "<div class='loading-seats'>Please select a movie</div>";
        }
    }

    // Populate times from schedules
    async function populateTimes() {
        timeSelect.innerHTML = '<option value="" disabled selected>-- Select a time --</option>';
        currentScheduleId = null;

        if (dateSelect.value && movieSelect.value) {
            const schedules = await getSchedulesForMovie(movieSelect.value);
            const timesForDate = schedules.filter(schedule => schedule.show_date === dateSelect.value);

            if (timesForDate.length > 0) {
                timesForDate.forEach(schedule => {
                    const option = document.createElement("option");
                    option.value = schedule.showtime;
                    option.textContent = `${schedule.showtime} (${schedule.available_seats} seats available)`;
                    option.dataset.scheduleId = schedule.id; // Store schedule ID for later use
                    timeSelect.appendChild(option);
                });

                timeSelect.disabled = false;

                // Auto-select the first time if available
                if (timesForDate.length > 0) {
                    timeSelect.value = timesForDate[0].showtime;
                    currentScheduleId = timesForDate[0].id;
                    await displaySeats();
                }
            } else {
                timeSelect.disabled = true;
                seatsContainer.innerHTML = "<div class='loading-seats'>No showtimes available for this date</div>";
            }
        } else {
            timeSelect.disabled = true;
            seatsContainer.innerHTML = "<div class='loading-seats'>Please select a showtime</div>";
        }
    }

    // Populate movies dropdown
    async function populateMovies() {
        try {
            const movies = await getAllMovies();

            // Clear existing options except the first one
            while (movieSelect.options.length > 1) {
                movieSelect.remove(1);
            }

            // Add movies from database
            movies.forEach(movie => {
                const option = document.createElement("option");
                option.value = movie.title;
                option.textContent = movie.title;
                movieSelect.appendChild(option);
            });

            // Auto-select the movie if coming from other pages
            if (movieToSelect) {
                const movieExists = movies.some(movie => movie.title === movieToSelect);
                if (movieExists) {
                    movieSelect.value = movieToSelect;
                    await populateDates();
                    localStorage.removeItem("selectedMovie");

                    // Update movie preview
                    updateMoviePreview(movieToSelect);
                }
            }
        } catch (error) {
            console.error('Error loading movies:', error);
            seatsContainer.innerHTML = "<div class='loading-seats'>Error loading movies. Please refresh the page.</div>";
        }
    }

    // Update movie preview
    function updateMoviePreview(selectedMovie) {
        const posterContainer = document.getElementById("posterContainer");
        const title = document.getElementById("previewTitle");
        const description = document.getElementById("previewDescription");
        const movieMeta = document.getElementById("movieMeta");
        const metaGenre = document.getElementById("metaGenre");
        const metaDuration = document.getElementById("metaDuration");
        const metaRating = document.getElementById("metaRating");
        const metaStatus = document.getElementById("metaStatus");

        if (selectedMovie && movieDetails[selectedMovie]) {
            // Update poster
            if (movieDetails[selectedMovie].poster) {
                posterContainer.innerHTML = `<img src="${movieDetails[selectedMovie].poster}" alt="${selectedMovie}" class="movie-poster" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
            } else {
                posterContainer.innerHTML = `<div class="no-poster">ðŸŽ¬ No Poster Available</div>`;
            }

            // Update title and description
            title.textContent = selectedMovie;
            description.textContent = movieDetails[selectedMovie].description;

            // Update metadata
            metaGenre.textContent = movieDetails[selectedMovie].genre || 'Not specified';
            metaDuration.textContent = movieDetails[selectedMovie].duration || 'Not specified';
            metaRating.textContent = movieDetails[selectedMovie].rating || 'Not rated';
            metaStatus.textContent = 'Now Showing';

            // Show metadata section
            movieMeta.style.display = 'grid';
        } else {
            // Reset to default state
            posterContainer.innerHTML = `<div class="no-poster">Select a Movie</div>`;
            title.textContent = "Select a Movie";
            description.textContent = "Please select a movie from the dropdown to view details.";
            movieMeta.style.display = 'none';
        }
    }

    function updateBookingFee() {
        const totalFee = selectedSeats.length * BOOKING_FEE_PER_TICKET;
        bookingFeeInput.value = totalFee;
        bookingFeeDisplay.textContent = `Booking Fee: â‚±${totalFee}`;
    }

    // Event listeners
    movieSelect.addEventListener("change", async () => {
        await populateDates();
        updateMoviePreview(movieSelect.value);
    });

    dateSelect.addEventListener("change", async () => {
        await populateTimes();
    });

    timeSelect.addEventListener("change", async () => {
        // Get the selected schedule ID from the option
        const selectedOption = timeSelect.options[timeSelect.selectedIndex];
        currentScheduleId = selectedOption.dataset.scheduleId;
        await displaySeats();
    });

    // Form validation
    bookingForm.addEventListener("submit", (e) => {
        if (selectedSeats.length === 0) {
            e.preventDefault();
            alert("Please select at least one seat.");
            return;
        }

        if (!movieSelect.value || !dateSelect.value || !timeSelect.value) {
            e.preventDefault();
            alert("Please fill in all required fields.");
            return;
        }
    });

    // Initialize the form
    document.addEventListener('DOMContentLoaded', async function() {
        await populateMovies();
    });
  </script>
</body>
</html>